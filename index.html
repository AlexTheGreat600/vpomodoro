<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d6efd">
    <meta name="description" content="A modern, feature-rich Pomodoro timer with stunning themes, custom activities, and powerful customization options.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vpomodoro">
    <title>Vpomodoro</title>
    <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="node_modules/bootstrap-icons/font/bootstrap-icons.min.css">
    <script defer src="node_modules/progressbar.js/dist/progressbar.min.js"></script>
    <script defer src="node_modules/chart.js/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --bg-color: #ffffff;
            --surface-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #0d6efd;
            --transition-speed: 0.3s;
            --font-family: system-ui, -apple-system, sans-serif;
            --font-size: 16px;
            --border-radius: 12px;
            --shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        /* Themes */
        [data-theme="monokai"] { --bg-color: #272822; --surface-color: #3e3d32; --text-color: #f8f8f2; }
        [data-theme="solarized-light"] { --bg-color: #fdf6e3; --surface-color: #eee8d5; --text-color: #586e75; }
        [data-theme="solarized-dark"] { --bg-color: #002b36; --surface-color: #073642; --text-color: #839496; }
        [data-theme="gruvbox-light"] { --bg-color: #fbf1c7; --surface-color: #f2e5bc; --text-color: #3c3836; }
        [data-theme="gruvbox-dark"] { --bg-color: #282828; --surface-color: #3c3836; --text-color: #ebdbb2; }
        [data-theme="nord"] { --bg-color: #2e3440; --surface-color: #3b4252; --text-color: #d8dee9; }
        [data-theme="dracula"] { --bg-color: #282a36; --surface-color: #44475a; --text-color: #f8f8f2; }
        [data-theme="ayu-light"] { --bg-color: #fafafa; --surface-color: #f3f3f3; --text-color: #5c6773; }
        [data-theme="ayu-dark"] { --bg-color: #0f1419; --surface-color: #171b24; --text-color: #bfbab0; }
        [data-theme="greenscreen"] { --bg-color: #001100; --surface-color: #002200; --text-color: #00ff00; --accent-color: #00ff00 !important; }

        * { 
            box-sizing: border-box; 
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed); 
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            display: flex; flex-direction: column;
            min-height: 100vh; overflow-x: hidden;
        }

        .container {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 20px; width: 100%; max-width: 650px; 
            margin: 0 auto; gap: 24px;
        }

        .ui-row {
            width: 100%; display: flex;
            justify-content: center; align-items: center;
            min-height: 50px; gap: 12px;
        }

        .tab-bar, .action-bar {
            background: var(--surface-color);
            padding: 6px; border-radius: 16px;
            max-width: 450px; width: 100%; margin: 0 auto;
        }

        .action-bar { display: flex; gap: 8px; background: transparent; padding: 0; }

        .settings-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .settings-actions button { width: 100%; justify-content: center; }

        button, select {
            background-color: var(--surface-color);
            color: var(--text-color);
            border: 2px solid transparent;
            padding: 10px 18px; border-radius: var(--border-radius);
            cursor: pointer; font-family: inherit; font-size: 1rem;
            display: flex; align-items: center; gap: 8px;
            transition: all 0.2s ease;
        }

        button:hover { border-color: var(--accent-color); transform: translateY(-2px); }
        button:active { transform: scale(0.95); }
        button.primary { background-color: var(--accent-color); color: white; padding: 12px 24px; }
        
        .tab-btn { flex: 1; border: none; padding: 10px; font-weight: 600; font-size: 0.9rem; white-space: nowrap; }
        .tab-btn.active { background: var(--accent-color); color: white; }

        .icon-btn { padding: 12px; border-radius: 50%; width: 45px; height: 45px; justify-content: center; flex-shrink: 0; }

        .action-bar select {
            flex: 1; min-width: 0; height: 45px; padding: 0 12px;
            appearance: none; text-align: center; border: 2px solid var(--surface-color);
        }

        #progress-container { width: 280px; height: 280px; margin: 0 auto; position: relative; }

        #timer-display {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3.2rem; font-weight: 700;
            transition: margin-top 0.3s ease, opacity 0.5s ease;
            cursor: pointer; user-select: none; z-index: 10;
        }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes fadeInUp { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }

        #main-wrapper { animation: 0.8s fadeInUp ease-out; }
        .paused:not(.at-start) #timer-display { animation: blink 1.5s infinite ease-in-out; }
        .semi-circle-mode #timer-display { margin-top: 40px; }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000;
            align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-color); padding: 30px; border-radius: 24px;
            width: 90%; max-width: 500px; max-height: 85vh;
            overflow-y: auto; box-shadow: var(--shadow);
        }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .chart-container { position: relative; height: 200px; width: 100%; }
        .chart-title { font-size: 0.8rem; text-align: center; margin-bottom: 5px; font-weight: bold; opacity: 0.8; }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }

        #thicknessVal::after { content: "px"; }

        .form-group input, .form-group select {
            width: 100%; padding: 12px; border-radius: 10px;
            border: 2px solid var(--surface-color); background: var(--surface-color); color: var(--text-color);
        }
    
        .accordion-wrapper { width: 100%; max-width: 380px; margin: 10px auto; }
        .shortcut-trigger { width: 100%; background: var(--surface-color); border-radius: 10px; padding: 6px 8px; font-size: 0.75rem; font-weight: 600; justify-content: center; opacity: 0.7; min-height: 32px; }
        .shortcut-content { display: none; background: var(--surface-color); margin-top: 4px; border-radius: 10px; padding: 12px; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.75rem; }
        .shortcut-item { display: flex; justify-content: space-between; align-items: center; }
        .kbd-key { background: var(--bg-color); padding: 2px 5px; border-radius: 4px; border: 1px solid var(--text-color); font-family: monospace; font-size: 0.7rem; min-width: 22px; text-align: center; }

        @media (max-width: 1024px) { .accordion-wrapper { display: none !important; } }
        @media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr; } .modal-content { padding: 20px; } }
        @media (max-width: 480px) { .tab-btn { font-size: 0.8rem; padding: 8px 4px; } #timer-display { font-size: 2.8rem; } .btn-label { display: none; } }
        @media (min-width: 481px) { .settings-actions { flex-direction: row; } .settings-actions button { flex: 1; } }
    </style>
</head>
<body class="paused at-start">

    <div class="container" id="main-wrapper">
        <div class="ui-row tab-bar">
            <button class="tab-btn active" onclick="setMode('work')"><i class="bi bi-briefcase-fill"></i> Work Time</button>
            <button class="tab-btn" onclick="setMode('break')"><i class="bi bi-cup-hot-fill"></i> Short Break</button>
            <button class="tab-btn" onclick="setMode('long')"><i class="bi bi-clock-history"></i> Long Break</button>
        </div>

        <div class="accordion-wrapper">
            <button class="shortcut-trigger" onclick="toggleAccordion()"><i class="bi bi-keyboard"></i> View Keyboard Shortcuts</button>
            <div id="shortcutContent" class="shortcut-content">
                <div class="shortcut-item"><span>Start/Pause</span> <span class="kbd-key">P</span></div>
                <div class="shortcut-item"><span>Reset</span> <span class="kbd-key">R</span></div>
                <div class="shortcut-item"><span>Work Mode</span> <span class="kbd-key">W</span></div>
                <div class="shortcut-item"><span>Short Break</span> <span class="kbd-key">B</span></div>
                <div class="shortcut-item"><span>Long Break</span> <span class="kbd-key">L</span></div>
                <div class="shortcut-item"><span>Random Act</span> <span class="kbd-key">A</span></div>
                <div class="shortcut-item"><span>Random Theme</span> <span class="kbd-key">T</span></div> 
                <div class="shortcut-item"><span>Fullscreen</span> <span class="kbd-key">F</span></div>
                <div class="shortcut-item"><span>Settings</span> <span class="kbd-key">S</span></div>
                <div class="shortcut-item"><span>Increase 1m</span> <span class="kbd-key">=</span></div>
                <div class="shortcut-item"><span>Decrease 1m</span> <span class="kbd-key">-</span></div>
            </div>
        </div>

        <div id="progress-container"><div id="timer-display" onclick="toggleTimer()">25:00</div></div>

        <div class="ui-row controls">
            <button class="icon-btn" onclick="adjustTime(-60)" title="Decrease 1 min"><i class="bi bi-dash-lg"></i></button>
            <button id="startPauseBtn" class="primary" onclick="toggleTimer()"><i class="bi bi-play-fill"></i> <span id="startBtnText" class="btn-label">Start</span></button>
            <button id="resetBtn" onclick="resetTimer()"><i class="bi bi-arrow-clockwise"></i> <span class="btn-label">Reset</span></button>
            <button id="fullscreenBtn" onclick="toggleFullscreen()"><i class="bi bi-arrows-fullscreen"></i> <span class="btn-label">Screen</span></button>
            <button class="icon-btn" onclick="adjustTime(60)" title="Increase 1 min"><i class="bi bi-plus-lg"></i></button>
        </div>

        <div class="ui-row action-bar">
            <button class="icon-btn" onclick="toggleModal('settingsModal')" title="Settings"><i class="bi bi-gear-fill"></i></button>
            <button class="icon-btn" onclick="selectRandomActivity()" title="Random Activity"><i class="bi bi-shuffle"></i></button>
            <select id="activitySelect" onchange="changeActivity()"></select>
            <button class="icon-btn" onclick="openStats()" title="Statistics"><i class="bi bi-bar-chart-fill"></i></button>
            <button class="icon-btn" onclick="toggleModal('activityModal')" title="Activities"><i class="bi bi-list-task"></i></button>
        </div>
    </div>

    <div id="statsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin:0">Usage Statistics</h3>
                <button class="icon-btn" onclick="toggleModal('statsModal')" style="width:35px; height:35px;"><i class="bi bi-x-lg"></i></button>
            </div>
            <div id="statsEmptyMsg" style="text-align: center; padding: 40px; opacity: 0.6; display: none;">
                <i class="bi bi-clipboard-data" style="font-size: 3rem;"></i>
                <p>No data recorded yet. Start working!</p>
            </div>
            <div class="stats-grid" id="statsGrid">
                <div><div class="chart-title">Time per Activity (Doughnut)</div><div class="chart-container"><canvas id="chartActivities"></canvas></div></div>
                <div><div class="chart-title">Time per Activity (Pie)</div><div class="chart-container"><canvas id="chartActivitiesPie"></canvas></div></div>
                <div><div class="chart-title">Time Comparison (Vertical)</div><div class="chart-container"><canvas id="chartTimeVertical"></canvas></div></div>
                <div><div class="chart-title">Time Comparison (Horizontal)</div><div class="chart-container"><canvas id="chartTimeHorizontal"></canvas></div></div>
                <div><div class="chart-title">Work vs. Break Ratio</div><div class="chart-container"><canvas id="chartRatio"></canvas></div></div>
                <div><div class="chart-title">Break Type Distribution</div><div class="chart-container"><canvas id="chartBreaks"></canvas></div></div>
            </div>
            <div class="settings-actions" style="margin-top: 30px;"><button onclick="clearStats()" style="color: #e06c75;"><i class="bi bi-trash"></i> Reset History</button></div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h3 style="margin:0">Settings</h3><button class="icon-btn" onclick="toggleModal('settingsModal')" style="width:35px; height:35px;"><i class="bi bi-x-lg"></i></button></div>
            <div class="form-group"><label>Theme</label><select id="themeSelect" onchange="applyTheme(this.value)"><option value="default">Random (Default)</option><option value="ayu-light">Ayu Light</option><option value="ayu-dark">Ayu Dark</option><option value="greenscreen">Greenscreen</option><option value="solarized-light">Solarized Light</option><option value="solarized-dark">Solarized Dark</option><option value="gruvbox-light">Gruvbox Light</option><option value="gruvbox-dark">Gruvbox Dark</option><option value="nord">Nord</option><option value="dracula">Dracula</option><option value="monokai">Monokai</option></select></div>
            <div class="form-group"><label>Font Family</label><select id="fontSelect" onchange="applyFont(this.value)"><option value="system-ui">System-ui</option><option value="sans-serif">Sans-serif</option><option value="monospace">Monospace</option><option value="serif">Serif</option><option value="cursive">Cursive</option></select></div>
            <div class="form-group"><label>Progress Bar Shape</label><select id="shapeSelect" onchange="applyShape(this.value)"><option value="Circle">Circle</option><option value="SemiCircle">Semi-Circle</option><option value="Line">Line</option></select></div>
            <div class="form-group"><label><span>Stroke Thickness</span> <span id="thicknessVal">6</span></label><input type="range" id="thicknessSelect" min="1" max="20" step="1" oninput="applyThickness(this.value)"></div>
            <div class="settings-actions"><button class="primary" onclick="saveSettings()">Save & Close</button><button class="primary" onclick="clearAllData()">Reset All Data</button></div>
        </div>
    </div>

    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h3 style="margin:0">Activities</h3><button class="icon-btn" onclick="toggleModal('activityModal')" style="width:35px; height:35px;"><i class="bi bi-x-lg"></i></button></div>
            <div id="activityList" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px; border: 2px solid var(--surface-color); border-radius: 12px;"></div>
            <h4 id="actFormTitle" style="margin-bottom: 12px; font-size: 1.1rem;">Add New Activity</h4>
            <input type="hidden" id="editId">
            <div class="form-group"><input type="text" id="newActName" placeholder="Activity Name"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;"><div class="form-group"><label>Work</label><input type="number" id="newActWork" value="25"></div><div class="form-group"><label>Break</label><input type="number" id="newActBreak" value="5"></div><div class="form-group"><label>Long</label><input type="number" id="newActLong" value="15"></div></div>
            <div class="form-group"><label>Accent Color</label><input type="color" id="newActColor" value="#0d6efd" style="height: 45px; padding: 5px; cursor: pointer;"></div>
            <div style="display: flex; gap: 10px;"><button id="actSubmitBtn" class="primary" style="flex: 2; justify-content: center;" onclick="handleActivitySubmit()">Add Activity</button><button id="actCancelBtn" style="flex: 1; justify-content: center; display: none;" onclick="resetActForm()">Cancel</button></div>
        </div>
    </div>

    <script>
        const defaultActivities = [
            { id: 'coding', name: 'üíª Coding', work: 50, break: 10, long: 30, color: '#61afef' },
            { id: 'reading', name: 'üìö Reading', work: 25, break: 5, long: 15, color: '#98c379' },
            { id: 'design', name: 'üé® Design', work: 40, break: 8, long: 20, color: '#e5c07b' },
            { id: 'writing', name: '‚úçÔ∏è Writing', work: 30, break: 5, long: 15, color: '#56b6c2' },
            { id: 'deepwork', name: 'üß† Deep Work', work: 90, break: 15, long: 45, color: '#e06c75' },
            { id: 'fitness', name: 'üèãÔ∏è Fitness', work: 45, break: 5, long: 20, color: '#d19a66' },
            { id: 'meditation', name: 'üßò Meditation', work: 15, break: 3, long: 10, color: '#c678dd' },
            { id: 'learning', name: 'üéì Learning', work: 55, break: 10, long: 25, color: '#4db5bd' },
            { id: 'chores', name: 'üßπ Chores', work: 20, break: 5, long: 10, color: '#abb2bf' },
            { id: 'gaming', name: 'üéÆ Gaming', work: 60, break: 15, long: 30, color: '#ff6c6b' },
            { id: 'social', name: 'üì± Social Media', work: 10, break: 2, long: 5, color: '#51afef' },
            { id: 'emails', name: 'üìß Emails', work: 20, break: 5, long: 10, color: '#98be65' }
        ];

        let activities = JSON.parse(localStorage.getItem('vp_activities')) || defaultActivities;
        let settings = JSON.parse(localStorage.getItem('vp_settings')) || { theme: 'default', font: "system-ui", shape: 'Circle', thickness: 6 };
        let history = JSON.parse(localStorage.getItem('vp_history')) || [];
        
        let timer = null, timeLeft = 0, totalTime = 0, isPaused = true, currentActivity = activities[0], progressBar = null, currentMode = 'work';
        let charts = [], currentSessionId = null, sessionSecondsTracked = 0;

        window.onload = () => {
            renderActivitySelect(); renderActivityList(); applySettings(); initProgressBar(); selectRandomActivity();
            if(settings.theme === 'default') {
                const themes = ['ayu-dark', 'nord', 'dracula', 'gruvbox-dark'];
                applyTheme(themes[Math.floor(Math.random() * themes.length)], false);
            }
        };

        function setMode(mode) {
            logSession(false); currentSessionId = null; currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const btnText = btn.innerText.toLowerCase().trim();
                if (mode === 'break') btn.classList.toggle('active', btnText === 'short break');
                else if (mode === 'long') btn.classList.toggle('active', btnText === 'long break');
                else btn.classList.toggle('active', btnText === 'work time');
            });
            resetTimer();
        }

        function initProgressBar() {
            const container = document.getElementById('progress-container');
            container.innerHTML = '<div id="timer-display" onclick="toggleTimer()"></div>';
            const weight = parseInt(settings.thickness);
            const config = { strokeWidth: weight, easing: 'easeInOut', duration: 1000, color: 'var(--accent-color)', trailColor: 'var(--surface-color)', trailWidth: weight * 0.7, svgStyle: { width: '100%', height: '100%' } };
            if (settings.shape === 'SemiCircle') { document.getElementById('main-wrapper').classList.add('semi-circle-mode'); progressBar = new ProgressBar.SemiCircle(container, config); }
            else if (settings.shape === 'Line') { document.getElementById('main-wrapper').classList.remove('semi-circle-mode'); progressBar = new ProgressBar.Line(container, config); }
            else { document.getElementById('main-wrapper').classList.remove('semi-circle-mode'); progressBar = new ProgressBar.Circle(container, config); }
            updateDisplay();
        }

        function updateDisplay() {
            const mins = Math.floor(timeLeft / 60), secs = timeLeft % 60;
            const timeStr = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            const display = document.getElementById('timer-display');
            if(display) display.innerText = timeStr;
            document.title = `${currentActivity.name} (${timeStr}) - Vpomodoro`;
            if (timeLeft === totalTime) document.body.classList.add('at-start'); else document.body.classList.remove('at-start');
            progressBar.animate(totalTime === 0 ? 0 : 1 - (timeLeft / totalTime));
        }

        function toggleTimer() {
            if (isPaused) {
                if (!currentSessionId) currentSessionId = Date.now();
                if ("Notification" in window && Notification.permission === "default") Notification.requestPermission();
                isPaused = false; document.body.classList.remove('paused');
                document.getElementById('startBtnText').innerText = "Pause";
                document.getElementById('startPauseBtn').querySelector('i').className = "bi bi-pause-fill";
                timer = setInterval(() => { 
                    if (timeLeft > 0) { timeLeft--; sessionSecondsTracked++; updateDisplay(); } 
                    else { clearInterval(timer); logSession(true); sendNotification("Time's Up!", `${currentActivity.name} session complete.`); alert("Time's up!"); resetTimer(); } 
                }, 1000);
            } else pauseTimer();
        }

        function pauseTimer() { isPaused = true; clearInterval(timer); logSession(false); document.body.classList.add('paused'); document.getElementById('startBtnText').innerText = "Start"; document.getElementById('startPauseBtn').querySelector('i').className = "bi bi-play-fill"; updateDisplay(); }
        function resetTimer() { pauseTimer(); currentSessionId = null; let duration = currentActivity.work; if(currentMode === 'break') duration = currentActivity.break; if(currentMode === 'long') duration = currentActivity.long; timeLeft = duration * 60; totalTime = timeLeft; updateDisplay(); }
        function adjustTime(amount) { timeLeft = Math.max(0, timeLeft + amount); totalTime = Math.max(totalTime, timeLeft); updateDisplay(); }
        
        function setActivity(id) { 
            logSession(false); currentSessionId = null;
            currentActivity = activities.find(a => a.id === id) || activities[0]; 
            document.documentElement.style.setProperty('--accent-color', currentActivity.color); 
            document.getElementById('activitySelect').value = currentActivity.id; 
            localStorage.setItem('vp_last_activity', currentActivity.id);
            resetTimer(); 
        }

        function selectRandomActivity() { setActivity(activities[Math.floor(Math.random() * activities.length)].id); }
        function changeActivity() { setActivity(document.getElementById('activitySelect').value); }

        function logSession(isCompleted = false) {
            if (sessionSecondsTracked <= 0) return;
            history.push({ sessionId: currentSessionId, activityId: currentActivity.id, activityName: currentActivity.name, mode: currentMode, duration: sessionSecondsTracked / 60, timestamp: Date.now(), color: currentActivity.color, completed: isCompleted });
            localStorage.setItem('vp_history', JSON.stringify(history));
            sessionSecondsTracked = 0; if (isCompleted) currentSessionId = null;
        }

        function openStats() {
            toggleModal('statsModal');
            if (history.length === 0) { document.getElementById('statsEmptyMsg').style.display = 'block'; document.getElementById('statsGrid').style.display = 'none'; }
            else { document.getElementById('statsEmptyMsg').style.display = 'none'; document.getElementById('statsGrid').style.display = 'grid'; setTimeout(initCharts, 100); }
        }

        function clearStats() { if(confirm("Wipe history?")) { history = []; localStorage.removeItem('vp_history'); toggleModal('statsModal'); } }

        function initCharts() {
            charts.forEach(c => c.destroy()); charts = [];
            const isDark = document.body.hasAttribute('data-theme') && ['monokai','solarized-dark','gruvbox-dark','nord','dracula','ayu-dark','greenscreen'].includes(document.body.getAttribute('data-theme'));
            Chart.defaults.color = isDark ? '#ebdbb2' : '#212529';
            
            const actStats = {}, breakStats = { short: 0, long: 0 };
            let totalWork = 0, totalBreak = 0;
            
            history.forEach(s => {
                if (s.mode === 'work') {
                    if (!actStats[s.activityId]) actStats[s.activityId] = { name: s.activityName, time: 0, color: s.color };
                    actStats[s.activityId].time += s.duration;
                    totalWork += s.duration;
                } else { 
                    totalBreak += s.duration; 
                    if (s.mode === 'break') breakStats.short += s.duration; else breakStats.long += s.duration; 
                }
            });

            const actLabels = Object.values(actStats).map(a => a.name);
            const actTimes = Object.values(actStats).map(a => a.time);
            const actColors = Object.values(actStats).map(a => a.color);
            const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

            // 1. Time per Activity (Doughnut)
            charts.push(new Chart(document.getElementById('chartActivities'), { 
                type: 'doughnut', 
                data: { labels: actLabels, datasets: [{ data: actTimes, backgroundColor: actColors, borderWidth: 0 }] }, 
                options: { ...commonOptions, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } } 
            }));

            // 2. Time per Activity (Pie)
            charts.push(new Chart(document.getElementById('chartActivitiesPie'), { 
                type: 'pie', 
                data: { labels: actLabels, datasets: [{ data: actTimes, backgroundColor: actColors, borderWidth: 0 }] }, 
                options: { ...commonOptions, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } } 
            }));

            // 3. Vertical Bar Chart
            charts.push(new Chart(document.getElementById('chartTimeVertical'), { 
                type: 'bar', 
                data: { labels: actLabels, datasets: [{ label: 'Minutes', data: actTimes, backgroundColor: actColors }] }, 
                options: { ...commonOptions, scales: { y: { beginAtZero: true } } } 
            }));

            // 4. Horizontal Bar Chart
            charts.push(new Chart(document.getElementById('chartTimeHorizontal'), { 
                type: 'bar', 
                data: { labels: actLabels, datasets: [{ label: 'Minutes', data: actTimes, backgroundColor: actColors }] }, 
                options: { ...commonOptions, indexAxis: 'y', scales: { x: { beginAtZero: true } } } 
            }));

            // 5. Work vs. Break Ratio
            charts.push(new Chart(document.getElementById('chartRatio'), { 
                type: 'pie', 
                data: { labels: ['Work', 'Rest'], datasets: [{ data: [totalWork, totalBreak], backgroundColor: ['#0d6efd', '#98c379'], borderWidth: 0 }] }, 
                options: { ...commonOptions, plugins: { legend: { display: true, position: 'bottom' } } } 
            }));

            // 6. Break Distribution
            charts.push(new Chart(document.getElementById('chartBreaks'), { 
                type: 'doughnut', 
                data: { labels: ['Short Break', 'Long Break'], datasets: [{ data: [breakStats.short, breakStats.long], backgroundColor: ['#56b6c2', '#c678dd'], borderWidth: 0 }] }, 
                options: { ...commonOptions, cutout: '70%', plugins: { legend: { display: true, position: 'bottom' } } } 
            }));
        }

        function handleActivitySubmit() {
            const name = document.getElementById('newActName').value, work = parseInt(document.getElementById('newActWork').value), breakTime = parseInt(document.getElementById('newActBreak').value), long = parseInt(document.getElementById('newActLong').value), color = document.getElementById('newActColor').value, editId = document.getElementById('editId').value;
            if(!name) return;
            if(editId) { const idx = activities.findIndex(a => a.id === editId); activities[idx] = { ...activities[idx], name, work, break: breakTime, long, color }; if(currentActivity.id === editId) setActivity(editId); }
            else { activities.push({ id: 'act_' + Date.now(), name, work, break: breakTime, long, color }); }
            saveActivities(); resetActForm();
        }

        function editActivity(id) { const act = activities.find(a => a.id === id); document.getElementById('actFormTitle').innerText = "Edit Activity"; document.getElementById('editId').value = act.id; document.getElementById('newActName').value = act.name; document.getElementById('newActWork').value = act.work; document.getElementById('newActBreak').value = act.break; document.getElementById('newActLong').value = act.long; document.getElementById('newActColor').value = act.color; document.getElementById('actSubmitBtn').innerText = "Update Activity"; document.getElementById('actCancelBtn').style.display = "block"; }
        function resetActForm() { document.getElementById('actFormTitle').innerText = "Add New Activity"; document.getElementById('editId').value = ""; document.getElementById('newActName').value = ""; document.getElementById('actSubmitBtn').innerText = "Add Activity"; document.getElementById('actCancelBtn').style.display = "none"; }
        function saveActivities() { localStorage.setItem('vp_activities', JSON.stringify(activities)); renderActivitySelect(); renderActivityList(); }
        function removeActivity(id) { if (activities.length <= 1) return; activities = activities.filter(a => a.id !== id); saveActivities(); if(currentActivity.id === id) setActivity(activities[0].id); }
        function sendNotification(title, body) { if (Notification.permission === "granted") new Notification(title, { body: body, icon: 'assets/favicon.svg' }); }
        function renderActivitySelect() { document.getElementById('activitySelect').innerHTML = activities.map(a => `<option value="${a.id}">${a.name}</option>`).join(''); }
        function renderActivityList() { document.getElementById('activityList').innerHTML = activities.map(a => `<div style="padding:12px; border-bottom:1px solid var(--surface-color); display:flex; justify-content:space-between; align-items:center;"><div><span style="color:${a.color}">‚óè</span> ${a.name}</div><div style="display:flex; gap:5px;"><button class="act-item-btn" onclick="editActivity('${a.id}')"><i class="bi bi-pencil"></i></button><button class="act-item-btn" onclick="removeActivity('${a.id}')" style="color:red"><i class="bi bi-trash"></i></button></div></div>`).join(''); }
        function toggleModal(id) { const m = document.getElementById(id); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
        function applyTheme(theme, save = true) { if (theme === 'default') document.body.removeAttribute('data-theme'); else document.body.setAttribute('data-theme', theme); if(save) { settings.theme = theme; saveSettings(); } }
        function applyFont(font) { document.documentElement.style.setProperty('--font-family', font); settings.font = font; }
        function applyShape(shape) { settings.shape = shape; initProgressBar(); }
        function applyThickness(val) { settings.thickness = val; document.getElementById('thicknessVal').innerText = val; initProgressBar(); }
        function applySettings() { document.getElementById('themeSelect').value = settings.theme; document.getElementById('fontSelect').value = settings.font; document.getElementById('shapeSelect').value = settings.shape; document.getElementById('thicknessSelect').value = settings.thickness; document.getElementById('thicknessVal').innerText = settings.thickness; applyTheme(settings.theme, false); applyFont(settings.font); }
        function saveSettings() { localStorage.setItem('vp_settings', JSON.stringify(settings)); if(document.getElementById('settingsModal').style.display === 'flex') toggleModal('settingsModal'); }
        function clearAllData() { if (confirm("Delete all data?")) { localStorage.clear(); window.location.reload(); } }
        function toggleAccordion() { const content = document.getElementById('shortcutContent'); content.style.display = content.style.display === 'grid' ? 'none' : 'grid'; }
        function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            switch(e.code) {
                case 'KeyP': toggleTimer(); break;
                case 'KeyR': resetTimer(); break;
                case 'KeyW': setMode('work'); break;
                case 'KeyB': setMode('break'); break;
                case 'KeyL': setMode('long'); break;
                case 'KeyS': toggleModal('settingsModal'); break;
                case 'KeyA': selectRandomActivity(); break;
                case 'KeyF': toggleFullscreen(); break;
                case 'KeyT': applyTheme(['ayu-light','ayu-dark','greenscreen','solarized-light','solarized-dark','gruvbox-light','gruvbox-dark','nord','dracula','monokai'][Math.floor(Math.random()*10)]); break;
                case 'Equal': e.preventDefault(); adjustTime(60); break;
                case 'Minus': e.preventDefault(); adjustTime(-60); break;
            }
        });
    </script>
</body>
</html>